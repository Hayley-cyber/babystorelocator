<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UK Baby Goods Stores Map</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: .75rem 1rem; border-bottom: 1px solid #e5e7eb; display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 1rem; margin: 0 .5rem 0 0; font-weight: 600; }
    .control { display: flex; gap: .5rem; align-items: center; }
    label { font-size: .9rem; color: #374151; }
    .checkboxes { display: flex; gap: .5rem; flex-wrap: wrap; max-height: 5.5rem; overflow: auto; padding: .3rem .4rem; border: 1px solid #e5e7eb; border-radius: .375rem; }
    .chip { display: inline-flex; align-items: center; gap: .25rem; padding: .25rem .5rem; border: 1px solid #d1d5db; border-radius: 999px; font-size: .8rem; }
    #map { height: 100%; width: 100%; }
    .footer { position: absolute; z-index: 1000; bottom: .75rem; left: .75rem; background: white; padding: .35rem .55rem; border-radius: .375rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,.06); font-size: .8rem; }
    .legend { display: flex; gap: .5rem; align-items: center; }
    .muted { color: #6b7280; }
    .popup h3 { margin: 0 0 .25rem 0; font-size: 1rem; }
    .popup .meta { font-size: .9rem; color: #4b5563; }
    .popup a { text-decoration: none; }
    .pill { padding: .1rem .4rem; border: 1px solid #e5e7eb; border-radius: 999px; font-size: .75rem; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>UK Baby Goods Stores</h1>
    <div class="control" style="min-width: 280px;">
      <label>Categories</label>
      <div id="categoryCheckboxes" class="checkboxes" title="Select one or more categories"></div>
    </div>
    <div class="control" style="min-width: 280px;">
      <label>Brands</label>
      <div style="display:flex;flex-direction:column;gap:.25rem;width:100%;"><input id="brandSearch" type="search" placeholder="Search brands…" style="padding:.25rem .4rem; border:1px solid #e5e7eb; border-radius:.375rem; font-size:.85rem;" /><div id="brandCheckboxes" class="checkboxes" title="Select one or more brands"></div></div>
    </div>
    <div class="control">
      <label for="searchBox">Search</label>
      <input id="searchBox" type="search" placeholder="Store or town…" />
    </div>
    <div class="control">
      <button id="resetBtn">Reset</button>
    </div>
  </header>
  <div id="map"></div>
</div>

<div class="footer">
  <div class="legend">
    <span class="muted">Tip:</span> Select any combination of categories and brands to filter.
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<!-- Papa Parse for CSV loading (optional) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const CONFIG = {
  DATA_SOURCE: 'stores-multicat.csv',
  START: { lat: 54.5, lng: -3.0, zoom: 6 },
  TILE_URL: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  TILE_ATTRIB: '&copy; OpenStreetMap contributors',
  MARKER: { radius: 8 }
};

const INLINE_STORES = [
  { name: "Little Angels Baby Store", lat: 51.5154, lng: -0.1410, address: "123 Oxford Street, London W1", phone: "020 7946 0000", email: "info@littleangels.co.uk", website: "https://example.com/london", categories: ["Strollers","Clothing"], brands: ["Bugaboo","Joie"] },
  { name: "North Star Baby", lat: 53.4808, lng: -2.2426, address: "1 Deansgate, Manchester M3", phone: "0161 555 1234", email: "hello@northstarbaby.co.uk", website: "https://example.com/manchester", categories: ["Feeding & Nursing","Car Seats"], brands: ["Tommee Tippee","Maxi-Cosi"] },
  { name: "West Coast Tots", lat: 55.8642, lng: -4.2518, address: "200 Sauchiehall St, Glasgow G2", phone: "0141 222 7788", email: "hi@westcoasttots.co.uk", website: "https://example.com/glasgow", categories: ["Strollers","Car Seats"], brands: ["UPPAbaby","Joie","Maxi-Cosi"] },
  { name: "Seaside Sprouts", lat: 50.8225, lng: -0.1372, address: "Brighton Lanes, Brighton BN1", phone: "01273 888 999", email: "team@seasidesprouts.co.uk", website: "https://example.com/brighton", categories: ["Clothing","Toys"], brands: ["Frugi","Jellycat"] }
];

const dedupe = (arr) => [...new Set(arr)];
const normalise = (s) => (s || '').toString().trim().toLowerCase();
const containsAny = (needles, hay) => needles.length === 0 || needles.some(b => hay.map(normalise).includes(normalise(b)));

const map = L.map('map').setView([CONFIG.START.lat, CONFIG.START.lng], CONFIG.START.zoom);
L.tileLayer(CONFIG.TILE_URL, { attribution: CONFIG.TILE_ATTRIB }).addTo(map);
let allStores = [];
let markersLayer = L.layerGroup().addTo(map);

const categoryCheckboxes = document.getElementById('categoryCheckboxes');
const brandCheckboxes = document.getElementById('brandCheckboxes');
const searchBox = document.getElementById('searchBox');
const resetBtn = document.getElementById('resetBtn');

resetBtn.addEventListener('click', () => {
  Array.from(categoryCheckboxes.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
  Array.from(brandCheckboxes.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
  searchBox.value = '';
  render();
});

searchBox.addEventListener('input', () => render());
categoryCheckboxes.addEventListener('change', () => render());
brandCheckboxes.addEventListener('change', () => render());

function buildUI(stores) {
  const categories = dedupe(stores.flatMap(s => s.categories || [])).sort((a,b)=>a.localeCompare(b));
  categoryCheckboxes.innerHTML = categories.map(c => {
    const id = 'cat_' + c.replace(/\W+/g,'_');
    return `<label class="chip"><input type="checkbox" value="${c}" id="${id}"/> ${c}</label>`;
  }).join('');

  const brands = dedupe(stores.flatMap(s => s.brands || [])).sort((a,b)=>a.localeCompare(b));
  brandCheckboxes.innerHTML = brands.map(b => {
    const id = 'brand_' + b.replace(/\W+/g,'_');
    return `<label class="chip"><input type="checkbox" value="${b}" id="${id}"/> ${b}</label>`;
  }).join('');
}

function getSelectedCategories() {
  return Array.from(categoryCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
}
function getSelectedBrands() {
  return Array.from(brandCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
}

function storeMatchesFilters(store) {
  const selectedCats = getSelectedCategories();
  const selectedBrands = getSelectedBrands();
  const q = normalise(searchBox.value);

  const catOk = containsAny(selectedCats, store.categories || []);
  const brandOk = containsAny(selectedBrands, store.brands || []);
  const hay = [store.name, store.address, ...(store.brands||[]), ...(store.categories||[])].map(normalise).join(' ');
  const searchOk = !q || hay.includes(q);

  return catOk && brandOk && searchOk;
}

function markerPopupHtml(s) {
  const cats = (s.categories||[]).map(c => `<span class="pill">${c}</span>`).join(' ');
  const brs = (s.brands||[]).map(b => `<span class="pill">${b}</span>`).join(' ');
  const website = s.website ? `<div><a href="${s.website}" target="_blank" rel="noopener">Website ↗</a></div>` : '';
  const phone = s.phone ? `<div>☎ ${s.phone}</div>` : '';
  const email = s.email ? `<div>✉ <a href="mailto:${s.email}">${s.email}</a></div>` : '';

  return `<div class="popup">
    <h3>${s.name}</h3>
    <div class="meta">${s.address || ''}</div>
    ${phone}${email}${website}
    <div style="margin-top:.35rem;">${cats}</div>
    <div style="margin-top:.25rem;">${brs}</div>
  </div>`;
}

function render() {
  markersLayer.clearLayers();
  const filtered = allStores.filter(storeMatchesFilters);
  filtered.forEach(s => {
    const marker = L.circleMarker([s.lat, s.lng], { radius: CONFIG.MARKER.radius });
    marker.bindPopup(markerPopupHtml(s));
    markersLayer.addLayer(marker);
  });
  if (filtered.length > 0) {
    const bounds = L.latLngBounds(filtered.map(s => [s.lat, s.lng]));
    map.fitBounds(bounds.pad(0.2), { animate: true });
  }
}

async function loadData() {
  if (CONFIG.DATA_SOURCE === 'csv') {
    try {
      const resp = await fetch('stores.csv', { cache: 'no-store' });
      if (!resp.ok) throw new Error('stores.csv not found');
      const text = await resp.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      const rows = parsed.data;
      allStores = rows.map(r => ({
        name: r.name,
        lat: parseFloat(r.lat),
        lng: parseFloat(r.lng),
        address: r.address,
        phone: r.phone,
        email: r.email,
        website: r.website,
        categories: (r.categories || '').split(';').map(s=>s.trim()).filter(Boolean),
        brands: (r.brands || '').split(';').map(s=>s.trim()).filter(Boolean)
      })).filter(s => isFinite(s.lat) && isFinite(s.lng));
    } catch (e) {
      console.warn('CSV load failed, falling back to inline data.', e);
      allStores = INLINE_STORES;
    }
  } else {
    allStores = INLINE_STORES;
  }
  buildUI(allStores);
  render();
}

const brandSearch = document.getElementById('brandSearch');
brandSearch.addEventListener('input', () => {
  const term = normalise(brandSearch.value);
  Array.from(brandCheckboxes.querySelectorAll('label.chip')).forEach(lbl => {
    const txt = normalise(lbl.textContent);
    lbl.style.display = !term || txt.includes(term) ? '' : 'none';
  });
});

loadData();
</script>
</body>
</html>
